{
  "name": "PaymentHandlerAgent",
  "version": "1.0.0",
  "description": "SmythOS agent for handling multi-gateway payment processing",
  "type": "transactional",
  "capabilities": [
    "payment_processing",
    "gateway_routing",
    "fraud_prevention",
    "refund_handling",
    "subscription_management"
  ],
  "inputs": [
    {
      "name": "action",
      "type": "string",
      "required": true,
      "enum": ["charge", "refund", "subscribe", "cancel", "verify"]
    },
    {
      "name": "payment_data",
      "type": "object",
      "required": true,
      "schema": {
        "amount": "decimal",
        "currency": "string",
        "method": "string",
        "user_id": "uuid",
        "entity_type": "string",
        "entity_id": "uuid",
        "metadata": "object"
      }
    },
    {
      "name": "gateway_preference",
      "type": "string",
      "required": false,
      "enum": ["stripe", "paypal", "mollie", "auto"]
    }
  ],
  "outputs": [
    {
      "name": "result",
      "type": "object",
      "schema": {
        "success": "boolean",
        "transaction_id": "string",
        "gateway_response": "object",
        "status": "string",
        "message": "string",
        "receipt_url": "string"
      }
    }
  ],
  "workflow": {
    "steps": [
      {
        "id": "validate_payment",
        "type": "validate",
        "description": "Validate payment data and amount"
      },
      {
        "id": "fraud_check",
        "type": "analyze",
        "description": "Perform fraud detection",
        "parameters": {
          "checks": ["velocity", "amount", "pattern", "device"]
        }
      },
      {
        "id": "select_gateway",
        "type": "decide",
        "description": "Select optimal payment gateway",
        "criteria": {
          "payment_method": "weight:40",
          "amount": "weight:20",
          "country": "weight:20",
          "gateway_health": "weight:20"
        }
      },
      {
        "id": "process_payment",
        "type": "branch",
        "branches": [
          {
            "condition": "gateway == 'stripe'",
            "steps": [
              {
                "id": "stripe_charge",
                "type": "api_call",
                "endpoint": "stripe.charges.create"
              }
            ]
          },
          {
            "condition": "gateway == 'paypal'",
            "steps": [
              {
                "id": "paypal_order",
                "type": "api_call",
                "endpoint": "paypal.orders.create"
              }
            ]
          },
          {
            "condition": "gateway == 'mollie'",
            "steps": [
              {
                "id": "mollie_payment",
                "type": "api_call",
                "endpoint": "mollie.payments.create"
              }
            ]
          }
        ]
      },
      {
        "id": "record_transaction",
        "type": "database",
        "operation": "insert",
        "table": "payments"
      },
      {
        "id": "emit_event",
        "type": "event",
        "event": "payment_processed"
      }
    ]
  },
  "gateways": {
    "stripe": {
      "supported_methods": ["card", "ideal", "sofort", "bancontact"],
      "webhook_endpoint": "/webhooks/stripe",
      "test_mode": true,
      "retry_policy": {
        "max_retries": 3,
        "backoff": "exponential"
      }
    },
    "paypal": {
      "supported_methods": ["paypal", "card"],
      "webhook_endpoint": "/webhooks/paypal",
      "test_mode": true,
      "retry_policy": {
        "max_retries": 2,
        "backoff": "linear"
      }
    },
    "mollie": {
      "supported_methods": ["ideal", "creditcard", "paypal", "sofort", "bancontact"],
      "webhook_endpoint": "/webhooks/mollie",
      "test_mode": true,
      "retry_policy": {
        "max_retries": 3,
        "backoff": "exponential"
      }
    }
  },
  "fraud_rules": {
    "velocity": {
      "max_transactions_per_hour": 5,
      "max_amount_per_day": 1000
    },
    "amount": {
      "max_single_transaction": 500,
      "require_3ds_above": 100
    },
    "patterns": {
      "block_duplicate_transactions": true,
      "duplicate_window": 60
    }
  },
  "compliance": {
    "pci_dss": true,
    "gdpr": true,
    "psd2": true,
    "data_retention": {
      "transaction_data": "7_years",
      "card_data": "never_store"
    }
  },
  "integrations": {
    "database": {
      "type": "postgresql",
      "tables": ["payments", "subscriptions", "refunds"]
    },
    "cache": {
      "type": "redis",
      "ttl": 60
    },
    "events": {
      "publisher": "redis",
      "topics": ["payment_events", "subscription_events"]
    },
    "api": {
      "endpoints": [
        {
          "path": "/payments/process",
          "method": "POST",
          "auth": "jwt"
        },
        {
          "path": "/payments/refund",
          "method": "POST",
          "auth": "jwt"
        },
        {
          "path": "/payments/status/:id",
          "method": "GET",
          "auth": "jwt"
        },
        {
          "path": "/webhooks/:gateway",
          "method": "POST",
          "auth": "webhook_signature"
        }
      ]
    }
  },
  "monitoring": {
    "metrics": [
      "payment_success_rate",
      "average_processing_time",
      "fraud_detection_rate",
      "gateway_failure_rate",
      "refund_rate"
    ],
    "alerts": [
      {
        "condition": "payment_success_rate < 0.95",
        "message": "Low payment success rate"
      },
      {
        "condition": "fraud_detection_rate > 0.02",
        "message": "High fraud detection rate"
      },
      {
        "condition": "gateway_failure_rate > 0.05",
        "message": "High gateway failure rate"
      }
    ]
  },
  "deployment": {
    "resources": {
      "cpu": "1",
      "memory": "512Mi"
    },
    "scaling": {
      "min_replicas": 2,
      "max_replicas": 10,
      "target_cpu_utilization": 50
    },
    "security": {
      "vault_integration": true,
      "secret_rotation": "30_days"
    }
  }
}